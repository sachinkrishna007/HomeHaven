<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.js"></script>

<%- include('./includes/header') %>
<br>
<br>
<br>
<br>
<!--================Checkout Area =================-->
<section class="checkout_area section_gap">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <!-- Billing Details section -->
        <div id="message" style="display: none;"></div>
        <div class="billing_details">
          <h3>Billing Details</h3>
          <% if (user.address.length > 0) { %>
          <form id="addressForm">
            <!-- <button class="btn-primary" type="submit">Select Address and Proceed</button> -->
            <% user.address.forEach((address, index) => { %>
            <div class="card mb-3">
              <div class="card-body">
                <label>
                  <input type="radio" name="selectedAddress" value="<%= address._id %>" <% if (index === 0) { %>checked<% } %>>
                  <h5 class="card-title">Address <%= index + 1 %></h5>
                  <p>Name: <%= address.name %></p>
                  <p>Mobile: <%= address.mobile %></p>
                  <p>Landmark: <%= address.landmark || 'N/A' %></p>
                  <p>City: <%= address.city %></p>
                  <p>State: <%= address.state %></p>
                  <p>Pincode: <%= address.pincode %></p>
                  <p>District: <%= address.district %></p>
                  <p>Address: <%= address.address %></p>
                  <!-- Add an "Edit Address" button -->
                </label>
              </div>
            </div>
            <% }) %>
            
           
          </form>
          <% } else { %>
          <p>No addresses added yet.</p>
          <% } %>
        </div>
        <!-- Rest of the checkout form -->
      </div>
      <div class="col-lg-4">
        <!-- Your Order section -->
        <div class="order_box">
          <h2>Your Order</h2>
          <ul class="list">
            <li>
              <div class="d-flex justify-content-between">
                <div><strong>Product</strong></div>
                <div><strong>Total</strong></div>
              </div>
            </li>
            <% let cartTotal = 0; %>
            <% cartItems.forEach((item, index) => { %>
            <li>
              <div class="d-flex justify-content-between">
                <div><%= item.carted.name %> <span class="middle">x <%= item.quantity %></span></div>
                <div>₹<%= item.total %></div>
              </div>
            </li>
            <% cartTotal += item.total; %>
            <% }) %>
          </ul>
          <ul class="list list_2">
            <li>Subtotal &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>₹<%= cartTotal %></span></li>
            <!-- Replace the shipping rate with your shipping rate calculation -->

            <!-- <div class="payment_item">
              <div class="radion_btn">
                <input type="radio" id="f-option5" name="selector" checked>
                <label for="f-option5">Check payments</label>
                <div class="check"></div>
              </div>
              <p>Please send a check to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p> -->
            <!-- </div> -->
            <form action="/checkout" method="post">
              <div class="payment_item active">
                <div class="radion_btn">
                  <input type="radio" id="f-option6" name="selector" >
                  <label for="f-option6">Paypal</label>
                  <img src="img/product/card.jpg" alt="">
                  <div class="check"></div>
                </div> 
              </div>
              <div class="payment_item active">
                <div class="radion_btn">
                  <input type="radio" id="selectedPaymentMethod" name="paymentMethod" value="COD"  >
                  <label for="selectedPaymentMethod">Cash On Delivery</label>
                  <img src="img/product/card.jpg" alt="">
                  <div class="check"></div>
                  <p>Please pay with cash upon delivery.</p>
                </div>
                <p>Pay via PayPal; you can pay with your credit card if you don’t have a PayPal account.</p>
              </div>
              <div class="creat_account">
                <input type="checkbox" id="f-option4" name="selector">
                <label for="f-option4">I’ve read and accept the </label>
                <a href="#">terms & conditions*</a>
              </div>
             
                <!-- ... Add your existing form fields here ... -->
  
                <!-- Add a hidden input field to hold the selected payment method -->
                <!-- <input type="hidden" id="selectedPaymentMethod" name="paymentMethod" value="COD"> -->
  
                <!-- Add the Proceed to Payment button -->
                <button type="submit" class="primary-btn">Proceed to Payment</button>
              </form>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>
<!--================End Checkout Area =================-->

<%- include('./includes/footer') %>

<!-- ... (rest of the HTML) ... -->

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const addressForm = document.getElementById("addressForm");
    const addressRadios = document.querySelectorAll('input[name="selectedAddress"]');

    // Add an event listener to each radio button to listen for the "change" event
    addressRadios.forEach((radio) => {
      radio.addEventListener("change", async (event) => {
        // Get the selected address ID from the radio button
        const selectedAddressId = event.target.value;

        try {
          // Send the selected address ID to the server using a fetch request
          const response = await fetch("/selectAddress", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ selectedAddress: selectedAddressId }),
          });

          if (response.ok) {
            console.log("Address selected successfully!");
          } else {
            console.error("Failed to select address");
          }
          messageDiv.style.display = "block";
        } catch (error) {
          console.error(error.message);
        }
      });
    });

    // Check if there is only one address and select it automatically
    if (addressRadios.length === 1) {
      // Since there's only one radio button, manually trigger the change event to select it
      addressRadios[0].dispatchEvent(new Event('change'));
    }
  });
</script>

<!-- ... (rest of the HTML) ... -->




<!-- <script>function checkCheckoutButton() {
  const addressSelected = document.querySelector( 'input[name="selectedAddress"]:checked');
  console.log(addressSelected);
  const paymentSelected = document.querySelector('input[name="paymentMethod"]:checked');

  const checkoutButton = document.getElementById('checkoutButton');

  if (addressSelected && paymentSelected) {
    checkoutButton.disabled = false;
  } else {
    checkoutButton.disabled = true;
}
}</script> -->

<style>
  .billing_details {
    max-height: 500px; /* Limit the height of the address section */
    overflow-y: auto; /* Enable scrolling if needed */
  }

  .card {
    /* Styles for each address card */
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 10px;
  }
</style>
